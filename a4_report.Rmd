---
title: "A4 Report - Insert Witty and Accurate Title Here"
author: "Cori Lopazanski, Kai Kopecky"
date: "11/14/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
```
***
### INTRODUCTION 

With the aim of increasing abundances of kelp forest species that are targeted by fisheries,  Marine Protected Areas (MPAs) have been established along the California coast to limit or prohibit fishing in areas deemed as important habitat for these species (cite). Monitoring efforts have been implemented to assess the effectiveness of these MPAs by comparing abundances of species inside and outside of the protected areas (cite). One such effort, undertaken by the Santa Barbara Coastal Long Term Ecological Research (SBC LTER) program, conducts yearly monitoring of kelp forest species in the Santa Barbara Channel inside and outside of MPAs. Within the Santa Barbara Channel, the California Spiny Lobster (*Panilurus interruptus*) is a species of interest, as it provides a lucrative fishery but also serves an important role in maintaining kelp forest ecosystems through predation of sea urchins (Tegner & Levin, 1983). Without predatory regulation, sea urchins can reach abundances high enough to decimate kelp populations and induce unfavorable ecosystem shifts from kelp forests to urchin barrens. Concern has been raised over whether increased fishing pressure on the *P. interruptus* in the Santa Barbara Channel has weakened this predator's regulatory role in culling urchin populations, and thus placed kelp forests at greater risk of undergoing phase shifts to urchin barrens. Here, we explore the effects of protection on *P. interruptus*  in the Santa Barbara Channel by comparing populations inside and outside of MPAs from 2012-2018.

***
### DATA AND METHODS 

Data for California spiny lobster abundance and size were collected and provided by researchers with the Santa Barbara Coastal Long-Term Ecological Research Program (SBC LTER). Divers collected annual estimates from 2012-2018 at five long-term kelp forest sites. Two sites (Naples and Isla Vista) are located in designated MPAs, which were created on 2012-01-01. The other three sites (Mohawk Reef, Carpinteria, and Arroyo Quemado) are located in unprotected areas. Estimates were collected annually in late summer, before the start of the fishing season, by counting lobsters and visually estimating the carapace length (mm) for each across a 40-meter transect at the five sites. 

Changes in annual lobster abundance over time were examined for each site by comparing the total lobster count for each year from 2012-2018. Size distributions were examined by comparing the size composition (mm) of the lobsters measured at each site in 2012 and in 2018. Mean lobster size was compared for lobsters measured in MPAs versus unprotected waters in 2012 and in 2018 using two-sample t-tests (alpha = 0.5 throughout). 

All data preparation and analyses were completed using R software (version 3.6.1) and RStudio (version 1.2.5001).


***
### RESULTS 

```{r packages and data wrangling}
# Attach packages and read in the data
library(tidyverse)
library(janitor) 
library(gghighlight)
library(ggridges)
library(effsize)
library(ggjoy)
library(kableExtra)
library(ggrepel)

lobster <- read_csv("lobster_abundance_sbc_lter.csv", na = c("-99999")) %>% 
  clean_names()
  
# Group observations to find lobster counts for each year
lobster_counts <- lobster %>% 
  group_by(year, site) %>% 
  summarize(
    annual_abundance = sum(count)
  ) %>% 
  mutate(site2 = ifelse(site == "NAPL", "Naples", 
                   ifelse(site == "MOHK", "Mohawk",
                   ifelse(site == "IVEE", "Isla Vista",
                    ifelse(site == "CARP", "Carpinteria", "Arroyo Quemado"))))) %>% 
  mutate(protection = ifelse(site %in% c("NAPL", "IVEE"), "Marine Protected Area", "Unprotected Area"))

lobster_count_label <- lobster_counts %>% 
  filter(year == "2018")

```

#### Trends in annual lobster abundance following MPA creation in 2012

The Isla Vista and Naples sites were declared MPAs in 2012, effectively eliminating fishing pressure for spiny lobsters in those areas. The trends in total annual lobster abundance for those two sites, as well as the three other unprotected sites, were compared for 2012-2018 (Fig. 1). 

```{r abundance over time}
# Visualize changes in annual lobster abundance at five sites over time
ggplot(data = lobster_counts, aes(x = year, y = annual_abundance)) +
  geom_line(aes(color = site2, label = site2, linetype = protection)) +
  geom_label_repel(data = lobster_count_label, 
                   box.padding = 0.5, 
                   size = 3,
                   nudge_x = 0.5, 
                   min.segment.length = 5, 
                   show.legend = FALSE,
                   xlim = c(2012, 2020), 
                   aes(x = year,
                       y = annual_abundance,
                       label = site2, 
                       color = site2))+
  guides(color = "none") +
  labs(
    x = "Year",
    y = "Annual Lobster Abundance",
    linetype = NULL) +
  theme_classic() +
  scale_x_continuous(limits = c(2012, 2019), expand = c(0, 0.5)) +
  scale_y_continuous(limits = c(0, 1000), expand = c(0,0)) +
  theme(
    legend.position = c(0.35, 0.7),
    legend.background = element_rect(color = "white"),
    plot.caption = element_text(hjust = 0), 
    panel.grid.minor.x = element_blank(), 
    panel.grid.minor.y = element_blank())

```

***Figure 1.*** *Total annual abundance of CA spiny lobsters for 5 sites in the Santa Barbara Channel from 2012 to 2018. Solid lines indicate sites within marine protected areas (Isla Vista and Naples) and dashed lines indicate sites in unprotected areas (Carpinteria, Mohawk, and Arroyo Quemado).*

```{r percent increase calculations}
percent_increase <- lobster_counts %>% 
  filter(year %in% c("2012", "2018")) %>% 
  arrange(site) %>% 
  group_by(site) %>% 
  mutate(
    pct_change = (annual_abundance/lag(annual_abundance) -1)*100
  ) %>% 
  select(site, pct_change) %>% 
  filter(!is.na(pct_change))
  
```

All sites have similar annual lobster abundance in 2012 and show an overall increase by 2018, but the two sites in Marine Protected Areas (Isla Vista and Naples) show a much greater increase than the sites in unprotected areas (Arroyo Quemado, Carpinteria, and Mohawk). From 2012 to 2018, annual lobster abundance at the Isla Vista and Naples sites increased by 3538% and 4866%, respectively. Percent increases in annual abundance were much smaller at the unprotected sites: though Carpinteria showed a drastic increase from 2015-2017, the overall increase in annual abundance was an order of magnitude smaller than the MPA sites (339%), and the other unprotected sites had even smaller changes at 42% and 98% (Arroyo Quemado and Mohawk, respectively). 




#### Shifts in lobster size distributions from 2012 to 2018

```{r, echo=FALSE}
# Convert lobster dataframe to tidy format subset for observations from 2012 and 2018 only
lobster_distributions <- lobster %>% 
  uncount(count) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, site, size_mm) %>% 
  filter(year == "2012" | year == "2018") %>% 
  mutate(site2 = ifelse(site == "NAPL", "Naples", 
                   ifelse(site == "MOHK", "Mohawk",
                   ifelse(site == "IVEE", "Isla Vista",
                    ifelse(site == "CARP", "Carpinteria", "Arroyo Quemado")))))

# Order factors so that MPA sites are together and at the top of the following plot
lobster_distributions$site2 <- ordered(lobster_distributions$site2, levels = c("Carpinteria", "Arroyo Quemado", "Mohawk", "Isla Vista", "Naples"))

# Ridge plot comparing lobster size distrubutions at the 5 sites in 2012 and 2018
ggplot(lobster_distributions, aes(x = size_mm, y = site2, fill = year))+
  geom_joy(data = filter(lobster_distributions, year == "2012"), alpha = 0.4, scale = 0.9)+
  geom_joy(data = filter(lobster_distributions, year == "2018"), alpha = 0.4, scale = 0.9)+
  theme_joy()+
  theme_minimal()+
  theme(plot.caption = element_text(hjust = 0,vjust = 0))+
  labs(x = "Carapace length (mm)",
       y = "Site",
       fill = NULL) 
  
```

***Figure 2.*** *Size distributions of the California Spiny Lobster at 5 sites in the Santa Barbara Channel (Naples and Isla Vista = within MPA; Mohawk, Arroyo Quemado, and Carpinteria = outside of MPA) in 2012 (red) and 2018 (blue). Sizes are measured as carapace length in mm.*

Both the MPA sites, Naples and Isla Vista, show visible increases in lobster size distribution from 2012 to 2018 (Fig. 2). Size distributions of lobsters in the non-MPA sites (Mohawk reef, Carpinteria, and Arroyo Quemado) appear relatively similar in both 2012 and 2018; however, Carpinteria and Arroyo Quemado show a modest increase in overall abundance between the two years.


### Statistical comparisons for CA spiny lobster monitoring efforts

// In text in your report, describe the outcome of the statistical hypothesis tests using in-line referencing (e.g. do not copy and paste values from the output). Remember: the p-value is not enough. You should also describe **more meaningful metrics for comparison**. Here are some things you might consider including in your description: the actual differences in mean size between groups, % changes, measure of uncertainty (e.g. confidence interval), etc. //

```{r part c mean size comparison, include=FALSE}
# Create column in distribution frame designating mpa/non_mpa protected status
mpa_comparison <- lobster_distributions %>% 
  mutate(protection = if_else(site %in% c("IVEE", "NAPL"), "mpa", "non_mpa"))

# Subset distribution data for year and status
mpa_2012 <- mpa_comparison %>% 
  filter(year == "2012" & protection == "mpa")

non_mpa_2012 <- mpa_comparison %>% 
  filter(year == "2012" & protection == "non_mpa")

mpa_2018 <- mpa_comparison %>% 
  filter(year == "2018" & protection == "mpa")

non_mpa_2018 <- mpa_comparison %>% 
  filter(year == "2018" & protection == "non_mpa")

# Summary table of mean, sd, sample size for later quick reference
summary_calc <- mpa_comparison %>% 
  group_by(year, protection) %>% 
  summarize(
    mean = mean(size_mm),
    sd = sd(size_mm),
    n = length(size_mm)
  )

# Mean, SD, Sample size for in-line referencing
mean_mpa_2012 <- mean(mpa_2012$size_mm)
mean_mpa_2018 <- mean(mpa_2018$size_mm)
mean_non_mpa_2012 <- mean(non_mpa_2012$size_mm)
mean_non_mpa_2018 <- mean(non_mpa_2018$size_mm)

sd_mpa_2012 <- sd(mpa_2012$size_mm)
sd_mpa_2018 <- sd(mpa_2018$size_mm)
sd_non_mpa_2012 <- sd(non_mpa_2012$size_mm)
sd_non_mpa_2018 <- sd(non_mpa_2018$size_mm)

n_mpa_2012 <- length(mpa_2012$size_mm)
n_mpa_2018 <- length(mpa_2018$size_mm)
n_non_mpa_2012 <- length(non_mpa_2012$size_mm)
n_non_mpa_2018 <- length(non_mpa_2018$size_mm)


# Look at the data even though we just looked at it cause allison says so and I guess its good practice
ggplot(data = mpa_comparison, aes(x = size_mm)) +
  geom_histogram() +
  facet_wrap(~year + ~protection)

ggplot(data = mpa_comparison, aes(sample = size_mm)) +
  geom_qq() +
  facet_wrap(~year + ~protection)

# Might not be normally distributed but CLT ... sample sizes large enough that means will be normally distributed so ok to do parametric test

# For 2012 observations, is there a significant difference in lobster size between MPA and non-MPA sites?
diff_2012_t <- t.test(mpa_2012$size_mm, non_mpa_2012$size_mm)
diff_2012_d <- cohen.d(mpa_2012$size_mm, non_mpa_2012$size_mm)

# For 2018 observations, is there a significant difference in lobster size between MPA and non-MPA sites?
diff_2018_t <- t.test(mpa_2018$size_mm, non_mpa_2018$size_mm)
diff_2018_d <- cohen.d(mpa_2018$size_mm, non_mpa_2018$size_mm)

# For MPA sites only, is there a significant difference in lobsters observed in 2012 vs. 2018?
diff_mpa_t <- t.test(mpa_2012$size_mm, mpa_2018$size_mm)
diff_mpa_d <- cohen.d(mpa_2012$size_mm, mpa_2018$size_mm)

# For non-MPA sites only, is there a significant difference in lobsters observed in 2012 vs. 2018?
diff_non_mpa_t <- t.test(non_mpa_2012$size_mm, non_mpa_2018$size_mm)
diff_non_mpa_d <- cohen.d(non_mpa_2012$size_mm, non_mpa_2018$size_mm)

```

***Table 1.*** *California Spiny Lobster size statistics for monitoring efforts inside and outside of MPAs in the Santa Barbara Channel for 2012 and 2018.*
```{r}
# Table for means, SD, and sample size of lobster sizes and abundances in 2012 and 2018
table_data <- as.tibble(summary_calc) %>% 
  select(protection, mean, sd, n) %>% 
  mutate(protection = ifelse(protection == "mpa", "MPA", "Non-MPA"))
  
lobster_table <- table_data %>% 
  kable(col.names = c("Protection", "Mean Size (mm)", "Standard Deviation", "Sample Size")) %>% 
  kable_styling(bootstrap_options = NULL,
                full_width = F) %>% 
  group_rows("2012", 1, 2) %>% 
  group_rows("2018", 3, 4) 

lobster_table
```

The mean size (mm) of lobsters measured in MPAs (`r round(mean_mpa_2012, 2)` $\pm$ `r round(sd_mpa_2012, 2)`, n = `r n_mpa_2012`) compared to unprotected waters (`r round(mean_non_mpa_2012, 2)` $\pm$ `r round(sd_non_mpa_2012, 2)`, n = `r n_non_mpa_2012`) differed significantly in 2012 (two-sample t-test, t(`r round(diff_2012_t$parameter, 2)`) = `r round(diff_2012_t$statistic, 2)`, *p* = `r round(diff_2012_t$p.value, 3)`). The mean lobster size was smaller in the MPAs (Table 1). 

By 2018, the size difference had changed: the mean lobster size (mm) mesured in MPAs (`r round(mean_mpa_2018, 2)` $\pm$ `r round(sd_mpa_2018, 2)`, n = `r n_mpa_2018`) still differed significantly from unprotected waters (`r round(mean_non_mpa_2018, 2)` $\pm$ `r round(sd_non_mpa_2018, 2)`, n = `r n_non_mpa_2018`) by a two-sample t-test (t(`r round(diff_2018_t$parameter, 2)`) = `r round(diff_2018_t$statistic, 2)`, *p* < 0.001), but this time the mean lobster size was larger in the MPA sites (Table 1). The increase in mean size of the lobsters in the MPA sites from 2012 to 2018 (from `r round(mean_mpa_2012, 2)` $\pm$ `r round(sd_mpa_2012, 2)`, n = `r n_mpa_2012` to `r round(mean_mpa_2018, 2)` $\pm$ `r round(sd_mpa_2018, 2)`, n = `r n_mpa_2018`) was also statistically significant (two-sample t-test, t(`r round(diff_mpa_t$parameter, 2)`) = `r round(diff_mpa_t$statistic, 2)`, *p* < 0.001). However, there was no significant difference (two-sample t-test, t(`r round(diff_non_mpa_t$parameter, 2)`) = `r round(diff_non_mpa_t$statistic, 2)`, *p* = `r round(diff_non_mpa_t$p.value, 2)`) in mean size of lobsters measured in sites in unprotected areas over the same time period (mean size of `r round(mean_non_mpa_2012, 2)` $\pm$ `r round(sd_non_mpa_2012, 2)`, n = `r n_non_mpa_2012` in 2012 to mean size of `r round(mean_non_mpa_2018, 2)` $\pm$ `r round(sd_non_mpa_2018, 2)`, n = `r n_non_mpa_2018` in 2018). 


***
## SUMMARY 

A brief summary of the major findings (pick 3 - 4) from your mini-report. A bullet-pointed list is fine, but the findings should be well-written, responsible (don’t overstate your findings), and refer to outcomes (e.g. figures, tables) in the Results section

***
## REFERENCES 
1. Tegner, M. J., and L. A. Levin. "Spiny lobsters and sea urchins: analysis of a predator-prey interaction." Journal of Experimental Marine Biology and Ecology 73.2 (1983): 125-150.

