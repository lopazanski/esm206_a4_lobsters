---
title: "A4 Report"
author: "Cori Lopazanski, Kai Kopecky"
date: "11/14/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
```
***
## INTRODUCTION: 

The California Spiny Lobster (*Panilurus interruptus*) serves as an important predator in kelp forest ecosystems by regulating sea urchin populations. If left unchecked, sea urchins can reach abundances high enough to decimate kelp populations and induce unfavorable ecosystem shifts from kelp forests to urchin barrens. Concern has been raised over whether increased fishing pressure on the California Spiny Lobster in the Santa Barbara Channel has weakened this predator's regulatory role in culling urchin populations, thus placing kelp forests at greater risk of undergoing phase shifts to urchin barrens. With the aim of increasing numbers of kelp forest species targeted by fisheries, several Marine Protected Areas (MPAs) have been established along the California coast to limit or prohibit fishing in areas deemed as important habitat. Monitoring efforts have been implemented to assess the effectiveness of these MPAs by comparing abundances of species inside and outside of the protected areas. One such effort is undertaken by the Santa Barbara Coastal Long Term Ecological Research (SBC LTER) program, which conducts yearly monitoring in the Santa Barbara Channel at 2 sites within MPAs (Naples and Isla Vista), and 3 sites outside of MPAs (Mohawk Reef, Carpinteria, and Arroyo Quemado). 

***
## DATA AND METHODS: 

A brief ‘Data and Methods’ section (5 - 6 sentences) summarizing the data and how it was analyzed. Briefly describe the variables being studied in this report. Include the types of statistical tests performed, significance level used, and software (with version) for analysis.

***
## RESULTS: 

Prepare finalized data visualizations and perform statistical analyses (as indicated) to do the following. You are expected to also add useful text that weaves the pieces together into a cohesive Results section (i.e., this should not just be a series of figures and without useful description & text flow between them). 

```{r packages and data wrangling}
# Attach packages and read in the data
library(tidyverse)
library(janitor) 
library(gghighlight)
library(ggridges)
library(effsize)
library(ggjoy)
library(ggrepel)

lobster <- read_csv("lobster_abundance_sbc_lter.csv", na = c("-99999")) %>% 
  clean_names()
  
# Group observations to find lobster counts for each year
lobster_counts <- lobster %>% 
  group_by(year, site) %>% 
  summarize(
    annual_abundance = sum(count)
  ) %>% 
  mutate(site2 = ifelse(site == "NAPL", "Naples", 
                   ifelse(site == "MOHK", "Mohawk",
                   ifelse(site == "IVEE", "Isla Vista",
                    ifelse(site == "CARP", "Carpinteria", "Arroyo Quemado"))))) %>% 
  mutate(protection = ifelse(site %in% c("NAPL", "IVEE"), "Marine Protected Area", "Unprotected Area"))

lobster_count_label <- lobster_counts %>% 
  filter(year == "2018")

```

#### Trends for lobster abundance at various sites

Visually explore changes in annual lobster abundance (counts) by site. After grouping observations to find lobster counts for each year, create a finalized data visualization (no modeling/stats needed) showing changes in annual lobster abundance at the five sites over time. You should decide how to best present the data. Make your data visualization correct, clear, responsible, and professional. Details matter (e.g. is it easier to read a legend or label lines directly? How can I designate between MPA and non-MPA sites? And many more decisions!). Add a figure caption below the graph.

In text (above or below the graph for Results A), describe general / interesting trends that you observe for lobster abundance at the 5 sites. 

```{r abundance over time}
# Visualize changes in annual lobster abundance at five sites over time
ggplot(data = lobster_counts, aes(x = year, y = annual_abundance)) +
  geom_line(aes(color = site2, label = site2, linetype = protection)) +
  geom_label_repel(data = lobster_count_label, 
                   box.padding = 0.5, 
                   size = 3,
                   nudge_x = 0.5, 
                   min.segment.length = 5, 
                   show.legend = FALSE,
                   xlim = c(2012, 2020), 
                   aes(x = year,
                       y = annual_abundance,
                       label = site2, 
                       color = site2))+
  guides(color = "none") +
  labs(
    title = "Annual lobster abundance following marine protected area creation in 2012",
    x = "Year",
    y = "Annual Lobster Abundance",
    caption = "Figure 1: Total annual abundance of CA spiny lobsters for 5 sites in the Santa Barbara Channel from 2012 to 2018. \nSolid lines indicate sites within marine protected areas (Isla Vista and Naples reefs) and dashed lines indicate sites \nin unprotected areas (Carpinteria, Mohawk, and Arroyo Quemado reefs).",
    linetype = NULL) +
  theme_classic() +
  scale_x_continuous(limits = c(2012, 2019), expand = c(0, 0.5)) +
  scale_y_continuous(limits = c(0, 1000), expand = c(0,0)) +
  theme(
    legend.position = c(0.35, 0.7),
    legend.background = element_rect(color = "white"),
    plot.caption = element_text(hjust = 0), 
    panel.grid.minor.x = element_blank(), 
    panel.grid.minor.y = element_blank())

```


#### Visualizing shifts in lobster size distributions from 2012 to 2018

```{r, echo=FALSE}

lobster_distributions <- lobster %>% 
  uncount(count) %>% 
  mutate(year = as.factor(year)) %>% 
  select(year, site, size_mm) %>% 
  filter(year == "2012" | year == "2018") %>% 
  mutate(site2 = ifelse(site == "NAPL", "Naples", 
                   ifelse(site == "MOHK", "Mohawk",
                   ifelse(site == "IVEE", "Isla Vista",
                    ifelse(site == "CARP", "Carpinteria", "Arroyo Quemado")))))

lobster_distributions$site2 <- ordered(lobster_distributions$site2, levels = c("Carpinteria", "Arroyo Quemado", "Mohawk", "Isla Vista", "Naples"))

ggplot(lobster_distributions, aes(x = size_mm, y = site2, fill = year))+
  geom_joy(data = filter(lobster_distributions, year == "2012"), alpha = 0.4, scale = 0.9)+
  geom_joy(data = filter(lobster_distributions, year == "2018"), alpha = 0.4, scale = 0.9)+
  theme_joy()+
  theme_minimal()+
  theme(plot.caption = element_text(hjust = 0))+
  labs(x = "Size (mm)",
       y = "Site",
       fill = "Year",
       title = "CA Spiny Lobster size distributions in the Sana Barbara Channel",
       caption = "Figure 2. Size distributions of the California Spiny Lobster at 5 sites in the Santa Barbara Channel\n(Naples and Isla Vista = within MPA; Mohawk, Arroyo Quemado, and Carpinteria = outside of MPA)\nin 2012 (red) and 2018 (blue). Sizes are measured as carapace length in mm.") 
  
  
#geom_text(lobster_distributions, stat = "Year" mapping = NULL, aes("MPA", x = 150, y = "Naples" ))
  


```
Both the MPA sites, Naples and Isla Vista, show visible increases in lobster size distribution from 2012 to 2018. Size distributions of lobsters in the non-MPA sites (Mohawk reef, Carpinteria, and Arroyo Quemado) appear relatively similar in both 2012 and 2018; however, Carpinteria and Arroyo Quemado show a modest increase in overall abundance between the two years.


### Results C. 

Compare mean lobster sizes at MPA vs. non-MPA sites in 2012 and 2018. Here, for each year (2012 and 2018) consolidate the size observations into only two groups: MPA and non-MPA lobsters. Then answer the following four questions: 

For 2012 observations, is there a significant difference in lobster size between MPA and non-MPA sites? 
For 2018 observations, is there a significant difference in lobster size between MPA and non-MPA sites? 
For MPA sites only, is there a significant difference in lobsters observed in 2012 vs. 2018?
For non-MPA sites only, is there a significant difference in lobsters observed in 2012 vs. 2018?

In your report for Results C, you should at least include:

A finalized table (interactive or static) that includes means, standard deviations, and sample sizes for the two groups (MPA and non-MPA sites) in 2012 and 2018. Add a caption (remember: table captions are above tables).

In text in your report, describe the outcome of the statistical hypothesis tests using in-line referencing (e.g. do not copy and paste values from the output). Remember: the p-value is not enough. You should also describe more meaningful metrics for comparison. Here are some things you might consider including in your description: the actual differences in mean size between groups, % changes, measure of uncertainty (e.g. confidence interval), etc.

```{r part c mean size comparison}
# Create column in distribution frame designating mpa/non_mpa protected status
mpa_comparison <- lobster_distributions %>% 
  mutate(protection = if_else(site %in% c("IVEE", "NAPL"), "mpa", "non_mpa"))

# Subset distribution data for year and status
mpa_2012 <- mpa_comparison %>% 
  filter(year == "2012" & protection == "mpa")

non_mpa_2012 <- mpa_comparison %>% 
  filter(year == "2012" & protection == "non_mpa")

mpa_2018 <- mpa_comparison %>% 
  filter(year == "2018" & protection == "mpa")

non_mpa_2018 <- mpa_comparison %>% 
  filter(year == "2018" & protection == "non_mpa")

# Summary table of mean, sd, sample size for later quick reference
summary_calc <- mpa_comparison %>% 
  group_by(year, protection) %>% 
  summarize(
    mean = mean(size_mm),
    sd = sd(size_mm),
    n = length(size_mm)
  )

# Mean, SD, Sample size for in-line referencing
mean_mpa_2012 <- mean(mpa_2012$size_mm)
mean_mpa_2018 <- mean(mpa_2018$size_mm)
mean_non_mpa_2012 <- mean(non_mpa_2012$size_mm)
mean_non_mpa_2018 <- mean(non_mpa_2018$size_mm)

sd_mpa_2012 <- sd(mpa_2012$size_mm)
sd_mpa_2018 <- sd(mpa_2018$size_mm)
sd_non_mpa_2012 <- sd(non_mpa_2012$size_mm)
sd_non_mpa_2018 <- sd(non_mpa_2018$size_mm)

n_mpa_2012 <- length(mpa_2012$size_mm)
n_mpa_2018 <- length(mpa_2018$size_mm)
n_non_mpa_2012 <- length(non_mpa_2012$size_mm)
n_non_mpa_2018 <- length(non_mpa_2018$size_mm)


# Look at the data even though we just looked at it cause allison says so and I guess its good practice
ggplot(data = mpa_comparison, aes(x = size_mm)) +
  geom_histogram() +
  facet_wrap(~year + ~protection)

ggplot(data = mpa_comparison, aes(sample = size_mm)) +
  geom_qq() +
  facet_wrap(~year + ~protection)

# Might not be normally distributed but CLT ... sample sizes large enough that means will be normally distributed so ok to do parametric test

# For 2012 observations, is there a significant difference in lobster size between MPA and non-MPA sites?
diff_2012_t <- t.test(mpa_2012$size_mm, non_mpa_2012$size_mm)
diff_2012_d <- cohen.d(mpa_2012$size_mm, non_mpa_2012$size_mm)

# For 2018 observations, is there a significant difference in lobster size between MPA and non-MPA sites?
diff_2018_t <- t.test(mpa_2018$size_mm, non_mpa_2018$size_mm)
diff_2018_d <- cohen.d(mpa_2018$size_mm, non_mpa_2018$size_mm)

# For MPA sites only, is there a significant difference in lobsters observed in 2012 vs. 2018?
diff_mpa_t <- t.test(mpa_2012$size_mm, mpa_2018$size_mm)
diff_mpa_d <- cohen.d(mpa_2012$size_mm, mpa_2018$size_mm)

# For non-MPA sites only, is there a significant difference in lobsters observed in 2012 vs. 2018?
diff_non_mpa_t <- t.test(non_mpa_2012$size_mm, non_mpa_2018$size_mm)
diff_non_mpa_d <- cohen.d(non_mpa_2012$size_mm, non_mpa_2018$size_mm)

```
Answers to questions with in-line referencing:

- For 2012 observations, is there a significant difference in lobster size between MPA and non-MPA sites?

In 2012, mean lobster size (mm) measured in designated marine protected areas (`r round(mean_mpa_2012, 2)` $\pm$ `r round(sd_mpa_2012, 2)`, n = `r n_mpa_2012`) differed significantly from lobsters measured in unprotected waters (`r round(mean_non_mpa_2012, 2)` $\pm$ `r round(sd_non_mpa_2012, 2)`, n = `r n_non_mpa_2012`) by a two-sample t-test (t(`r round(diff_2012_t$parameter, 2)`) = `r round(diff_2012_t$statistic, 2)`, *p* = `r round(diff_2012_t$p.value, 3)`).
  
- For 2018 observations, is there a significant difference in lobster size between MPA and non-MPA sites? 

In 2018, mean lobster size (mm) measured in designated marine protected areas (`r round(mean_mpa_2018, 2)` $\pm$ `r round(sd_mpa_2018, 2)`, n = `r n_mpa_2018`) differed significantly from lobsters measured in unprotected waters (`r round(mean_non_mpa_2018, 2)` $\pm$ `r round(sd_non_mpa_2018, 2)`, n = `r n_non_mpa_2018`) by a two-sample t-test (t(`r round(diff_2018_t$parameter, 2)`) = `r round(diff_2018_t$statistic, 2)`, *p* < 0.001).

- For MPA sites only, is there a significant difference in lobsters observed in 2012 vs. 2018?

For lobsters measured in marine protected areas, mean size in 2012 (`r round(mean_mpa_2012, 2)` $\pm$ `r round(sd_mpa_2012, 2)`, n = `r n_mpa_2012`) differed significantly from mean size in 2018 (`r round(mean_mpa_2018, 2)` $\pm$ `r round(sd_mpa_2018, 2)`, n = `r n_mpa_2018`) by a two-sample t-test (t(`r round(diff_mpa_t$parameter, 2)`) = `r round(diff_mpa_t$statistic, 2)`, *p* < 0.001).

- For non-MPA sites only, is there a significant difference in lobsters observed in 2012 vs. 2018?

For lobsters measured outside of marine protected areas, mean size in 2012 (`r round(mean_non_mpa_2012, 2)` $\pm$ `r round(sd_non_mpa_2012, 2)`, n = `r n_non_mpa_2012`) did not differ significantly from mean size in 2018 (`r round(mean_non_mpa_2018, 2)` $\pm$ `r round(sd_non_mpa_2018, 2)`, n = `r n_non_mpa_2018`) by a two-sample t-test (t(`r round(diff_non_mpa_t$parameter, 2)`) = `r round(diff_non_mpa_t$statistic, 2)`, *p* = `r round(diff_non_mpa_t$p.value, 2)`). 

***
## SUMMARY: 

A brief summary of the major findings (pick 3 - 4) from your mini-report. A bullet-pointed list is fine, but the findings should be well-written, responsible (don’t overstate your findings), and refer to outcomes (e.g. figures, tables) in the Results section

***
## REFERENCES: 

References (including for data sources & literature cited in your introduction) that were used to prepare the report. Reference formatting matters - 

